# Technical Specification

This document defines the project structure, tooling choices, and development setup for the Multi-Tenant SaaS Platform.

## 1. Project Structure
Top-level repository layout (single repo with three main areas and documentation):

- backend/ — Express.js + Prisma API server
- frontend/ — Next.js application
- docs/ — research, PRD, architecture, API docs, images
- docker-compose.yml (later in Phase 6)

### 1.1 Backend (Express + Prisma)

Proposed structure:

backend/
├── prisma/
│   ├── schema.prisma            # Prisma data model (tenants, users, projects, tasks, audit_logs)
│   ├── migrations/              # Auto-generated by Prisma Migrate
│   └── seed.ts                  # Seeds: super_admin, demo tenant, users, projects, tasks
├── src/
│   ├── config/
│   │   └── env.ts               # Environment variable loading and validation
│   ├── db/
│   │   └── client.ts            # PrismaClient singleton
│   ├── middleware/
│   │   ├── auth.ts              # JWT verification; attach userId, tenantId, role
│   │   ├── rbac.ts              # Role-based access control helpers
│   │   ├── tenant.ts            # Tenant isolation (auto-filter helpers)
│   │   ├── validate.ts          # Request validation middleware (zod/express-validator)
│   │   └── error.ts             # Centralized error handler
│   ├── modules/
│   │   ├── auth/
│   │   │   ├── auth.controller.ts
│   │   │   ├── auth.routes.ts
│   │   │   └── auth.service.ts
│   │   ├── tenants/
│   │   │   ├── tenants.controller.ts
│   │   │   ├── tenants.routes.ts
│   │   │   └── tenants.service.ts
│   │   ├── users/
│   │   │   ├── users.controller.ts
│   │   │   ├── users.routes.ts
│   │   │   └── users.service.ts
│   │   ├── projects/
│   │   │   ├── projects.controller.ts
│   │   │   ├── projects.routes.ts
│   │   │   └── projects.service.ts
│   │   └── tasks/
│   │       ├── tasks.controller.ts
│   │       ├── tasks.routes.ts
│   │       └── tasks.service.ts
│   ├── services/
│   │   ├── audit.service.ts     # Insert audit_logs entries
│   │   └── subscription.service.ts # Check plan limits
│   ├── utils/
│   │   ├── crypto.ts            # bcrypt hashing/compare
│   │   ├── jwt.ts               # sign/verify
│   │   └── responses.ts         # uniform {success, message, data}
│   ├── routes.ts                # Mount all module routes with middlewares
│   ├── app.ts                   # Express app wiring (CORS, JSON, routes, error)
│   └── server.ts                # Start server, health check readiness gating
├── package.json
├── tsconfig.json
├── .env.example                 # Backend env vars template (dev/test values later committed to .env)
├── Dockerfile                   # Backend container image (migrate + seed on start)
└── README.md                    # Backend-specific notes (optional)

Notes:
- Sessions table is optional; we use JWT-only per spec.
- Health: GET /api/health returns {status, database} after migrations + seeds complete.
- CORS: Allow requests from FRONTEND_URL env (http://frontend:3000 in Docker).

### 1.2 Frontend (Next.js App Router)

frontend/
├── app/
│   ├── layout.tsx
│   ├── page.tsx                 # Redirects to /dashboard when authenticated
│   ├── login/page.tsx
│   ├── register/page.tsx
│   ├── dashboard/page.tsx
│   ├── projects/page.tsx
│   ├── projects/[projectId]/page.tsx
│   └── users/page.tsx           # Tenant admin only (guarded)
├── components/
│   ├── Navbar.tsx
│   ├── Protected.tsx            # Auth guard wrapper
│   ├── forms/
│   │   ├── LoginForm.tsx
│   │   ├── RegisterTenantForm.tsx
│   │   ├── ProjectForm.tsx
│   │   └── UserForm.tsx
│   ├── modals/
│   │   ├── ProjectModal.tsx
│   │   └── UserModal.tsx
│   └── ui/                      # Buttons, inputs, badges, etc.
├── lib/
│   ├── api.ts                   # Axios instance with interceptors and baseURL
│   ├── auth.ts                  # Token helpers (storage), user/role utilities
│   └── types.ts                 # Shared TS types for responses
├── styles/
│   └── globals.css
├── public/
├── next.config.mjs
├── package.json
├── tsconfig.json
├── .env.example                 # NEXT_PUBLIC_API_BASE_URL template
└── Dockerfile                   # Frontend container (build + serve)

Notes:
- Use service name base URL in Docker: NEXT_PUBLIC_API_BASE_URL=http://backend:5000/api
- Client-side auth: on mount, call /api/auth/me; redirect to /login if 401.
- Role-based UI: conditionally render links/actions based on role.

## 2. Development Setup Guide

### 2.1 Prerequisites
- Node.js 18+
- npm or pnpm (your choice; default npm)
- Docker Desktop (for local containers)
- Git

### 2.2 Environment Variables

Backend (.env)
- PORT=5000
- NODE_ENV=development
- FRONTEND_URL=http://localhost:3000 (Docker: http://frontend:3000)
- JWT_SECRET=dev_secret_at_least_32_chars
- JWT_EXPIRES_IN=24h
- DB_HOST=localhost (Docker: database)
- DB_PORT=5432
- DB_NAME=saas_db
- DB_USER=postgres
- DB_PASSWORD=postgres

Frontend (.env)
- NEXT_PUBLIC_API_BASE_URL=http://localhost:5000/api (Docker: http://backend:5000/api)

Note: Per spec, a .env with dev values will be committed for evaluation, or variables will be embedded in docker-compose.yml.

### 2.3 Local Development (without Docker)

Backend
```bash
cd backend
npm install
npx prisma generate
npx prisma migrate dev --name init
npm run seed   # or: ts-node prisma/seed.ts if script configured
npm run dev    # starts on http://localhost:5000
```

Frontend
```bash
cd frontend
npm install
npm run dev    # starts on http://localhost:3000
```

### 2.4 Running with Docker (single command in Phase 6)
- Use `docker-compose up -d` at repo root. This will start database, backend, and frontend with fixed ports 5432/5000/3000. Backend will run migrations and seeds automatically.

### 2.5 Testing
- Placeholder until tests are added:
  - Backend: `npm test` in backend (we will configure Jest/Vitest in later phases).
  - Frontend: `npm test` in frontend if unit/component tests are added.

### 2.6 Coding Conventions
- TypeScript on both backend and frontend.
- API responses: `{ success, message?, data? }` with proper HTTP status.
- Validation: zod/express-validator for request schemas.
- Linting/formatting: ESLint + Prettier (to be added in setup phase of each app).

## 3. Notes on Compliance with Requirements
- Multi-tenancy: Shared DB + shared schema with tenant_id; super_admin has tenantId null.
- RBAC: Three roles enforced via middleware and guarded routes.
- Subscription plans: free/pro/enterprise with max_users and max_projects enforced by backend services.
- Health check: `/api/health` reports API and DB readiness after migrations/seeds.
- Docker: Three services named `database`, `backend`, `frontend`, fixed external ports 5432/5000/3000.
- Auto init: Backend entrypoint runs migrations + seed on startup; no manual steps.
